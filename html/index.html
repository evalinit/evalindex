<!doctype html>
<html lang="en">
<head>
  <title>eval index</title>
</head>
<body>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script>
    function geval(code) {
      eval(code)
    }
    (function () {
      const subdomain = window.location.host.split('.')[0]
      let myPeerId
      let remotePeerId
      let secret
      if (subdomain.endsWith('-server')) {
        myPeerId = subdomain
        secret = prompt('SECRET')
      } else {
        remotePeerId = `${subdomain}-server`
      }
      window.me = new Peer(myPeerId, {
        host: 'peerjspoc.caveon.com',
        path: '/myapp',
        secret: secret
      })
      window.me.on('open', (id) => {
        let index = localStorage.getItem('index.js')
        if (remotePeerId) {
          // get init from remote peer
          window.conn = window.me.connect(remotePeerId)
          window.conn.on('open', () => {
            window.conn.on('data', (payload) => {
              if (payload.type == 'eval') {
                geval(payload.code)
              }
            })
            window.conn.send({
              type: 'init',
              href: window.location.href
            })
          })
        }
        geval(index)
      })
    }())
  </script>
</body>
</html>
