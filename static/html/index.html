<!doctype html>
<html lang="en">
<head>
  <title>eval index</title>
</head>
<body>
  <script>
    const gval = eval;
    (async () => {
      gval(localStorage.getItem('index.js'))
      const connfig = {
        iceServers: [
          {
            urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302', 'stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302']
          }
        ]
      }
      const splitHost = window.location.host.split('.')
      const serverIdx = splitHost.indexOf('server')
      const name = splitHost[0]
      if (serverIdx > 0) {
        const secret = localStorage.getItem('secret') || prompt('secret')
        let sock
        createSocket()
        function createSocket () {
          if (sock) return
          sock = new WebSocket(`${window.location.protocol.replace('http', 'ws')}//${window.location.host}/signal/socket`)
          sock.onclose = () => {
            sock = null
          }
          sock.onopen = () => {
            const payload = {
              type: 'connect',
              data: {
                name: name,
                secret: secret
              }
            }
            sock.send(JSON.stringify(payload))
          }
          sock.addEventListener('message', async (e) => {
            const { type, data, meta } = JSON.parse(e.data)
            switch (type) {
              case 'connected':
                setInterval(createSocket, 1000)
                break
              case 'offer':
                if (JSON.parse(localStorage.getItem('hold'))) break
                const conn = new RTCPeerConnection(connfig)
                window.dispatchEvent(new CustomEvent('connection', {
                  detail: {
                    conn: conn
                  }
                }))
                conn.setRemoteDescription(data['offer'])
                const answer = await conn.createAnswer()
                conn.setLocalDescription(answer)
                const candidates = []
                conn.onicecandidate = async (event) => {
                  if (event.candidate) {
                    candidates.push(event.candidate)
                  } else {
                    const payload = {
                      type: 'answer',
                      data: {
                        answer: answer,
                        candidates: candidates
                      },
                      meta: meta
                    }
                    sock.send(JSON.stringify(payload))
                  }
                }
                for (const candidate of data['candidates']) {
                  await conn.addIceCandidate(new RTCIceCandidate(candidate))
                }
                break
              case 'hook':
                console.log('heard hook here', data)
                window.dispatchEvent(new CustomEvent('hook', {
                  detail: data
                }))
                break
            }
          })
        }
      }
////////////////////
        else
////////////////////
      {
        window.conn = new RTCPeerConnection(connfig)
        const channel = conn.createDataChannel('eval')
        channel.onmessage = (event) => {
          gval(event.data)
        }
        const offer = await conn.createOffer()
        conn.setLocalDescription(offer)
        const candidates = []
        conn.onicecandidate = async (event) => {
          if (event.candidate) {
            candidates.push(event.candidate)
          } else {
            const payload = {
              server_name: name,
              offer: offer,
              candidates: candidates
            }
            const response = await fetch('/signal/offer', {
              method: 'post',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            })
            const responseJson = await response.json()
            if (Object.keys(responseJson).length) {
              conn.setRemoteDescription(responseJson.answer)
              for (const candidate of responseJson.candidates) {
                await conn.addIceCandidate(new RTCIceCandidate(candidate))
              }
            }
          }
        }
      }
    })()
  </script>
</body>
</html>
