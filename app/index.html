<!doctype html>
<html lang="en">
<head>
  <title>Knitialize</title>
  <style>
    .center {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <script>
    (function () {
      const splitDomain = window.location.host.split('.')
      const subdomain = splitDomain[0]
      let mode
      let password
      let myPeerId
      let remotePeerId
      if (subdomain.endsWith('-server')) {
        mode = 'server'
        myPeerId = subdomain
        // TODO: modify peerjs-server to check this password against hashes stored in memory before giving them the peer id
        password = prompt('Password')
      } else {
        mode = 'client'
        remotePeerId = `${subdomain}-server`
      }
      const me = new Peer(myPeerId, {
        host: 'peerjspoc.caveon.com',
        path: '/myapp',
        port: '',
        password: password
      })
      me.on('open', (id) => {
        me.on('error', (err) => {
          if (err.type == 'peer-unavailable') {
            document.body.innerHTML = `<div class="center"><div>${subdomain} is offline`
          }
        })
        if (mode == 'server') {
          me.on('connection', (conn) => {
            conn.on('data', (payload) => {
              if (payload.type == 'init') {
                const appKey = payload.href.split('/')[3] || 'index'
                const serverJs = localStorage.getItem(`${appKey}.server.js`)
                if (serverJs) eval(serverJs)
                const html = localStorage.getItem(`${appKey}.html`) || '<div class="center"><div>404'
                const css = localStorage.getItem(`${appKey}.css`) || ''
                const js = localStorage.getItem(`${appKey}.js`)
                conn.send({
                  type: 'init',
                  html: html,
                  css: css,
                  js: js
                })
              }
            })
          })
          const servingAtSubDomain = subdomain.split('-')[0]
          const domain = splitDomain.slice(1).join('.')
          document.body.innerHTML = `<div class="center"><div>serving at https://${servingAtSubDomain}.${domain}`
        }
        else {
          conn = me.connect(remotePeerId)
          conn.on('open', () => {
            conn.on('data', (payload) => {
              if (payload.type == 'init') {
                document.body.innerHTML = payload.html
                document.getElementsByTagName('style')[0].innerText = payload.css
                eval(payload.js)
              }
            })
            conn.send({
              type: 'init',
              href: window.location.href
            })
          })
        }
      })
    }(window))
  </script>
</body>
</html>
